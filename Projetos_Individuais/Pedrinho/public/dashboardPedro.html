<!DOCTYPE html>
<html lang="en">

<script>
  var vetor_Componentes = []
  var nome = sessionStorage.NOME_EMPRESA 

    // ---------------------------------  Obter Componentes
    fetch("/usuarios/ObterComponentes", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkTorreServer: fkTorre,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO entrar()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          json.forEach(element => {
            vetor_Componentes.push(element.fkComponente)
          });
        });
      }
    }).catch(function (erro) {
      console.log("ERRO: " + erro);
    })
    setTimeout(() =>
      ObterTemperatura(sessionStorage.ID_TORRE),
      ObterPlacaMae(sessionStorage.ID_TORRE),
      ObterDesempenho(sessionStorage.ID_TORRE)
      , 2000);
    setTimeout(() => AparecerGraficos(vetor_Componentes, fkTorre), 3000);


  function AparecerGraficos(vetor_Componentes, fkTorre) {
    vetor_Componentes.forEach(element => {
       if (element == 22) {
        lista.innerHTML += `<div class="CardGrafico"><h4 style="margin-top: 10px; margin-bottom: 0px;">Temperatura da CPU</h4><canvas style="width: 100%; display: block;" id="myChartPUT"></canvas></div>`
        setTimeout(() => PlotarGrafico(vetor_Temperatura, sessionStorage.ID_TORRE, 'myChartPUT', 'Temperatura em Celsius'), 2000);
      }  else if (element == 23) {
        lista.innerHTML += `<div class="CardGrafico"><h4 style="margin-top: 10px; margin-bottom: 0px;">Temperatura da Placa Mãe</h4><canvas style="width: 100%; display: block;" id="myChartPUM"></canvas></div>`
        setTimeout(() => PlotarGrafico(vetor_PlacaMae, sessionStorage.ID_TORRE, 'myChartPUM', 'Temperatura em Celsius'), 2000);
      } else if (element == 24) {
        lista.innerHTML += `<div class="CardGrafico"><h4 style="margin-top: 10px; margin-bottom: 0px;">Desempenho CPU</h4><canvas style="width: 100%; display: block;" id="myChartDese"></canvas></div>`
        setTimeout(() => PlotarGrafico(vetor_PercaDesem, sessionStorage.ID_TORRE, 'myChartDese', 'Perca de Desempenho em %'), 2000);
      }
    });
  }
</script>

<script>
  var vetor_leituras = []
  var vetor_Temperatura = []
  var vetor_PlacaMae = []
  var vetor_PercaDesem= []

  function ObterTemperatura(fkTorre) {
    fetch(`/medidas/Temperatura/${fkTorre}`, { cache: 'no-store' }).then(function (response) {
      metrica = 49
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();
          console.log(resposta)
          resposta.forEach(element => {
            vetor_Temperatura.push(element.Temperatura)
          });

          // PlotarGrafico(resposta, fkTorre);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  function ObterPlacaMae(fkTorre) {
    fetch(`/medidas/PlacaMae/${fkTorre}`, { cache: 'no-store' }).then(function (response) {
      metrica = 49
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();
          console.log(resposta)
          resposta.forEach(element => {
            vetor_PlacaMae.push(element.PlacaMae)
          });

          // PlotarGrafico(resposta, fkTorre);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  function ObterDesempenho(fkTorre) {
    fetch(`/medidas/Desempenho/${fkTorre}`, { cache: 'no-store' }).then(function (response) {
      metrica = 49
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();
          console.log(resposta)
          resposta.forEach(element => {
            vetor_PercaDesem.push(element.Desempenho)
          });

          // PlotarGrafico(resposta, fkTorre);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  function PlotarGrafico(vetor, fkTorre, idCanva, label) {
    var fkComponenteVar = 0
     if (idCanva == 'myChartPUT') {
      fkComponenteVar = 22
    } else if (idCanva == 'myChartPUM') {
      fkComponenteVar = 23
    } else if (idCanva == 'myChartDese') {
      fkComponenteVar = 24
    } 

    for (i = 0; i < vetor.length; i++) {
      vetor_leituras.push({ DataHora: vetor_DataHora[i], Leitura: vetor[i] })
    }

    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [{
        label: label,
        data: [],
        fill: false,
        borderColor: '#ffc107',
        tension: 0.1
      },]
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(vetor_leituras)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < vetor_leituras.length; i++) {
      var registro = vetor_leituras[i];
      labels.push(registro.DataHora);
      dados.datasets[0].data.push(registro.Leitura);
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'line',
      data: dados,
      options: {
        scales: {
          yAxes: [{
            ticks: {
              suggestedMin: 0,
              suggestedMax: 100
            }
          }]
        }
      }
    };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById(idCanva),
      config
    );
    vetor_leituras = []
    setTimeout(() => atualizarGrafico(fkTorre, fkComponenteVar, dados, myChart), 5000);

  }


  function atualizarGrafico(fkTorre, fkComponente, dados, myChart) {
    fetch(`/medidas/tempo-real/${fkTorre}/${fkComponente}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
          console.log(`Dados atuais do gráfico:`);
          console.log(dados);


          if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
            console.log("---------------------------------------------------------------")
            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
            console.log("Horário do novo dado capturado:")
            console.log(novoRegistro[0].momento_grafico)
            console.log("Horário do último dado capturado:")
            console.log(dados.labels[dados.labels.length - 1])
            console.log("---------------------------------------------------------------")
          } else {
            // tirando e colocando valores no gráfico
            dados.labels.shift(); // apagar o primeiro
            dados.labels.push(novoRegistro[0].momento_grafico.slice(11)); // incluir um novo momento

            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
            dados.datasets[0].data.push(novoRegistro[0].Leitura); // incluir uma nova medida de umidade

            let metrica = novoRegistro[0].Leitura

            myChart.update();

            if (fkComponente == 22) {
              verificarTemperatura(metrica)
            }

            if (fkComponente == 23) {
              verificarPlacaMae(metrica)
            }

            if (fkComponente == 24) {
              perdendoDesempenho(metrica)
            }
          }


          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(fkTorre, fkComponente, dados, myChart), 5000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(fkTorre, fkComponente, dados, myChart), 5000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


</script>

<script>
  function alertas(nome, componente, metrica, frase) {

    const options = {
      method: 'POST',
      headers: {
        accept: 'application/json',
        Authorization: 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJ1c2VyIjp7ImlkIjozMDIwOTE4NzAsImVtYWlsIjoicmVuYXRvLnRpZXJub0BzcHRlY2guc2Nob29sIiwiYXBwbGljYXRpb24iOjMwMDIwMDc5OX19.u1OD3vfD6im7FYV9owyD6kVPdstkeU3_1tX-WJdZz0Pf5VM8QZ2VEO6vEye9ht82VD7t2bnBqMwtuWywW0rjEg',
        'content-type': 'application/json'
      },
      body: JSON.stringify({
        query: `mutation {           createCard(input: {             pipe_id:302621694,             title: "Card",             fields_attributes:[               {field_id: "nome_da_empresa", field_value: "${nome}"},{field_id: "descri_o_do_alerta", field_value: "${componente}"},{field_id: "m_tricas", field_value: " ${frase}${metrica}"}             ],           }) {               card {                 title               }             }           }`
      })
    };
    fetch('https://api.pipefy.com/graphql', options)
      .then(response => response.json())
      .then(response => console.log(response))
      .catch(err => console.error(err));
  }

  
  function verificarTemperatura(metrica) {
    var frase = ""
    // incluir uma nova medida de temperatura  
    if (metrica > 49 && metrica < 69) {
      frase = "Alerta: Temperatura Acima do Ideal! Temperatura: "
      console.log('Cheguei aqui')
      alertas(nome, "CPU", metrica, frase)
    } else if (metrica >= 70) {
      frase = "Perigo: Temperatura Critica! Temperatura: "
      alertas(nome, "Temperatura", metrica, frase)
    }
  }

  
  function verificarPlacaMae(metrica) {
    var frase = ""
    // incluir uma nova medida de temperatura  
    if (metrica > 40 && metrica < 60) {
      frase = "Alerta: Temperatura Acima do Ideal! Temperatura: "
      console.log('Cheguei aqui')
      alertas(nome, "Placa Mãe", metrica, frase)
    } else if (metrica >= 61) {
      frase = "Perigo: Temperatura Critica! Temperatura: "
      alertas(nome, "PlacaMae", metrica, frase)
    }
  }

  function perdendoDesempenho(metrica){

    var frase = ""   
    // incluir uma nova medida de temperatura  
    if (metrica > 3.5 && metrica < 6.9){
      frase = "Alerta: Perca de Desempenho Consideravel !"
      console.log('Cheguei aqui')
      alertas(nome, "Desempenho CPU", metrica, frase)
    } else if (metrica > 7.0) {
      frase = "Perigo: Perca de Desempenho Critica!"
      alertas(nome, "Desempenho", metrica, frase)
    }
  }    
  
</script>

